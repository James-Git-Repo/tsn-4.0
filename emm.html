<!doctype html>
<html lang="en" data-mode="viewer">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="stylesheet" href="assets/global-responsive.css">
<script defer src="assets/global-responsive.js"></script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<link rel="stylesheet" href="assets/foundation.css">
<link rel="stylesheet" href="assets/access-mode.css">
<script defer src="assets/mode-compat.js"></script>
<script defer src="assets/access-mode.js"></script>

  <title>European Market Movers — Weekly</title>
  <meta name="description" content="European Market Movers — a PM-style weekly wrap of European markets: what moved, why it mattered, what’s next."/>

  <style>
    /* --- Modal footer layout fix (overrides viewer CSS) --- */
    .dlg-actions button,
    .dialog-foot button {
      width: auto !important;
      display: inline-flex !important;
    }
    .dlg-actions{ display:flex; gap:10px; justify-content:flex-end; align-items:center; }
    .dialog-foot{ display:flex; gap:10px; justify-content:space-between; align-items:center; }
  </style>

  <style>
    :root{ --page:#ffffff; --ink:#0b152c; --muted:#4c5c83; --line:#e7edf7; --card:#ffffff; --primary:#1f4aff; --accent:#00b7ff; --chip:#eef4ff; --maxw:1120px; --shadow:0 10px 30px rgba(12,23,52,.08) }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--ink); background:var(--page)}
    header{position:sticky; top:0; z-index:40; backdrop-filter:saturate(140%) blur(8px); background:rgba(255,255,255,.9); border-bottom:1px solid var(--line)}
    .wrap{max-width:var(--maxw); margin:0 auto; padding:0 20px}
    img, video { max-width:100%; height:auto; display:block }
    .nav{height:72px; display:flex; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:12px}
    .mark{width:36px; height:36px; border-radius:12px; display:grid; place-items:center; color:#fff; background:conic-gradient(from 210deg, var(--primary), var(--accent)); box-shadow:var(--shadow)}
    nav ul{display:flex; list-style:none; gap:12px; margin:0; padding:0}
    .pill-btn{appearance:none; display:inline-flex; align-items:center; gap:6px; text-decoration:none; background:#fff; color:#1f3aa2; border:1.5px solid #dbe6ff; border-radius:14px; padding:12px 18px; font-weight:800; font-size:16px; line-height:1; transition:background .15s ease, box-shadow .15s ease; box-shadow:0 1px 0 rgba(12,23,52,.02)}
    .pill-btn:hover{ background:#f4f7ff }
    .pill-btn.primary{ background:linear-gradient(180deg,#2954ff,#1f4aff); color:#fff; border-color:#2140b8; box-shadow:0 6px 18px rgba(31,74,255,.20), inset 0 1px 0 rgba(255,255,255,.25) }
    .pill-row{display:flex; align-items:center; gap:12px}

    /* Hero */
    .hero{border-bottom:1px solid var(--line)}
    .hero.financial{ position:relative; background-image:linear-gradient(180deg, rgba(31,74,255,0.12), rgba(0,183,255,0.08)), var(--hero, linear-gradient(180deg,#f7faff 0%,#ffffff 60%)); background-size:cover; background-position:center }
    .hero.financial::before{ content:""; position:absolute; inset:0; background-image:linear-gradient(to right, rgba(12,23,52,0.06) 1px, transparent 1px), linear-gradient(to bottom, rgba(12,23,52,0.06) 1px, transparent 1px); background-size:48px 48px; pointer-events:none }
    .hero.financial::after{ content:""; position:absolute; top:-30%; right:-20%; width:60%; height:160%; background:radial-gradient(closest-side, rgba(31,74,255,0.18), transparent 70%); pointer-events:none }
    .hero .inner{position:relative; max-width:var(--maxw); margin:0 auto; padding:40px 20px}
    .cover-title{font-size: clamp(30px, 3.8vw, 48px); line-height:1.08; margin:6px 0; color:#0b152c}

    /* Editor + article + comments */
    .editor{background:#fff; border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); padding:14px; margin:18px 0}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; font-weight:700; color:#3a4a74}
    .field input,.field textarea,.field select{font:inherit; padding:10px 12px; border:1px solid #cad7f5; border-radius:10px}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .tabs{display:flex; gap:8px; margin:6px 0}
    .tabs button{padding:6px 10px; border:1px solid #cad7f5; background:#fff; border-radius:999px; font-weight:700; cursor:pointer}
    .tabs button.active{background:#e9f1ff}
    .article{margin:0 0 40px}
    .post-head h1{font-size: clamp(28px, 4vw, 46px); line-height:1.08; margin:6px 0}
    .post-head .subtitle{color:var(--muted); margin:0 0 8px 0}
    .meta{display:flex; align-items:center; gap:8px; flex-wrap:wrap; color:#5d6a8e; font-size:13px}
    .chip{background:var(--chip); border:1.5px solid #dbe6ff; color:#2140b8; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px}

    /* Prose */
    .prose p{margin:1em 0; line-height:1.68}
    .prose h2{margin-top:1.4em; font-size:1.25rem}
    .prose img{max-width:100%; border-radius:12px; display:block; margin:12px 0}
    .prose figure{margin:14px 0}
    .prose figcaption{font-size:12px; color:#5d6a8e; text-align:center}
    .prose blockquote{border-left:4px solid var(--line); padding:6px 12px; color:#3a4a74; background:#f7faff; border-radius:8px}
    .prose ul,.prose ol{margin:1em 0; padding-left:1.2em}
    .prose ul{list-style:disc} .prose ol{list-style:decimal}
    .prose li{margin:.25em 0}
    .prose table{width:100%; border-collapse:collapse; margin:1em 0}
    .prose th,.prose td{border:1px solid var(--line); padding:8px 10px; text-align:left}
    .prose thead th{background:#f7faff}
    .prose pre,.prose code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .prose pre{background:#f7faff; border:1px solid var(--line); border-radius:8px; padding:10px; overflow:auto}

    .comments{border-top:1px solid var(--line); padding-top:18px; margin-top:24px}
    .comment-item{padding:12px 0; border-bottom:1px solid var(--line)}
    .comment-item:last-child{border-bottom:0}
    .comment-author{font-weight:700}
    .comment-meta{font-size:12px; color:#6b7897}
    .comment-text{margin:8px 0 0 0; white-space:pre-wrap}

    /* Cards (feed) */
    .cards{ display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap:14px }
    .card{
      display:flex; flex-direction:column; background:#fff; border:1px solid var(--line);
      border-radius:16px; box-shadow:var(--shadow); overflow:hidden; cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
      text-decoration:none; color:inherit;
    }
    .card:focus-visible{ outline:3px solid #99b3ff; outline-offset:3px }
    .card:hover{ transform:translateY(-1px); box-shadow:0 12px 36px rgba(12,23,52,.10) }
    .card .thumb{ aspect-ratio:16/9; background:#eef4ff; object-fit:cover; width:100% }
    .card .body{ padding:12px }
    .card h4{ margin:0 0 4px 0; font-size:16px; line-height:1.25; font-weight:800; color:#0b152c }
    .card .deck{ margin:0 0 8px 0; color:#4c5c83; font-size:13px }
    .card .meta{ display:flex; gap:8px; flex-wrap:wrap; color:#5d6a8e; font-size:12px }

    /* --- Modal footer buttons: reset & restore original layout --- */
    .modal-actions{
      display:flex; gap:10px; justify-content:flex-end; align-items:center;
      margin-top:12px;
    }
    .modal-actions button{
      width:auto; display:inline-flex; align-items:center; justify-content:center;
      appearance:none; cursor:pointer;
      padding:10px 16px; border-radius:14px; font-weight:800; line-height:1.1;
      border:1.5px solid #dbe6ff; background:#fff; color:#1f3aa2;
    }
    .modal-actions .btn-primary{ background:#1f4aff; color:#fff; border-color:#1f4aff; }
    .modal-actions .btn-ghost{ background:transparent; color:#0b152c; border-color:transparent; }
    .modal-actions button:focus-visible{ outline:2px solid #1f4aff; outline-offset:2px; }
    @media (max-width:480px){ .modal-actions{ flex-wrap:wrap; justify-content:flex-end; } }

    /* Responsive */
    @media (max-width: 640px){
      .hero .inner{ padding:28px 16px }
      .cover-title{ font-size: clamp(24px, 7vw, 36px) }
      .cards{ grid-template-columns:1fr; gap:12px }
      .prose p{ line-height:1.72 }
      .pill-btn{ padding:14px 18px }
      #articleToolbar{ position:sticky; top:76px; background:#fff; z-index:30; padding:8px 0 }
    }
    @media (min-width: 641px) and (max-width: 1024px){ .cards{ grid-template-columns: repeat(2, 1fr) } }
    @media (min-width: 1025px){ .cards{ grid-template-columns: repeat(3, 1fr) } }

    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
    .hide{display:none}
    footer{border-top:1px solid var(--line); padding:18px 0; color:#6b7897}
  </style>

  
  <link rel="stylesheet" href="assets/site-responsive.css">


  <!-- === Contribute dialog — bright layout (matches your screenshot) === -->
  <style>
    #contribDialog{
      padding:0; border:none; border-radius:18px;
      width:min(880px, calc(100vw - 32px));
      box-shadow:0 30px 80px rgba(12,23,52,.28);
    }
    #contribDialog::backdrop{
      background:rgba(11,21,44,.45);
      backdrop-filter:blur(2px);
    }
    #contribDialog .dlg-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:16px 18px;
      font-weight:800; border-bottom:1px solid #e7edf7;
      background:linear-gradient(180deg,#f7faff,#eef4ff);
      border-radius:18px 18px 0 0;
    }
    #contribDialog .dlg-head .close-x{
      appearance:none; border:1.5px solid #dbe6ff; border-radius:12px;
      padding:8px 14px; font-weight:800; background:#fff; color:#1f3aa2; cursor:pointer;
    }
    #contribDialog .dlg-body{
      padding:16px 18px; background:#fff; color:#0b152c;
    }
    #contribDialog .two{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:640px){ #contribDialog .two{ grid-template-columns:1fr; } }
    #contribDialog .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    #contribDialog .field label{ font-size:12px; font-weight:800; color:#3a4a74; }
    #contribDialog input, #contribDialog textarea, #contribDialog select{
      display:block; width:100%; padding:12px; border-radius:12px;
      border:1.5px solid #cad7f5; background:#fff; color:#0b152c; box-sizing:border-box;
    }
    #contribDialog input[type="file"]{ padding:9px 12px; }
    #contribDialog textarea{ min-height:180px; resize:vertical; }
    #contribDialog .consent{ display:flex; align-items:center; gap:8px; font-size:14px; color:#3a4a74; margin:6px 0 0 2px; }
    #contribDialog small.hint{ display:block; margin-top:8px; color:#6b7897; }

    #contribDialog .dlg-actions{
      display:flex; justify-content:flex-end; align-items:center; gap:10px;
      padding:12px 16px; background:#f7faff; border-top:1px solid #e7edf7;
      border-radius:0 0 18px 18px;
    }
    #contribDialog .pill-btn{ display:inline-flex; width:auto; align-items:center; justify-content:center; }
    #contribDialog .btn-primary{ background:#1f4aff; color:#fff; border-color:#1f4aff; }
    #contribDialog .btn-ghost{ background:transparent; color:#0b152c; border-color:transparent; }
  </style>
  <style id="nav-fallback">
/* Fallback: hamburger visibile solo <980px; menu a pannello */
.nav-toggle{display:none;}
@media (max-width:980px){
  .nav-toggle{
    display:inline-flex; appearance:none; border:1px solid #dbe6ff; background:#fff; color:#143166;
    width:40px; height:40px; border-radius:10px; align-items:center; justify-content:center; cursor:pointer;
  }
  header nav{ position:static; margin-left:0; flex:unset; }
  header nav ul{
    position:absolute; right:16px; top:72px; display:none; flex-direction:column; gap:10px;
    background:#fff; border:1px solid #e7edf7; border-radius:14px; padding:12px;
    box-shadow:0 10px 30px rgba(12,23,52,.10); z-index:50; min-width:220px;
  }
  body.nav-open header nav ul{ display:flex; }
  header nav a{ display:block; width:100%; text-align:left; min-height:44px; }
}
</style>

<script defer src="assets/ui-mode-toggle.js"></script>
</head>
<body>
  <header>
    <div class="wrap nav">
      <div class="brand"><div class="mark" aria-hidden="true">TSN</div><h1 class="text-lg font-extrabold">The (un)Stable Net</h1></div>
      <button id="navToggle" class="nav-toggle" aria-controls="primaryNav" aria-expanded="false" data-view-allowed>
      <span class="sr-only">Toggle navigation</span>
      <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
      <nav id="primaryNav" aria-label="Primary">
        <ul class="pill-row">
          <li><a class="pill-btn" href="home.html">Home</a></li>
          <li><button id="openContrib" class="pill-btn primary" type="button" data-view-allowed>Contribute</button></li>
        </ul>
      </nav>
       
    </div>
  </header>

  <!-- Hero -->
  <section class="hero financial" aria-label="Section cover">
    <div class="inner">
      <h2 class="cover-title">European Market Movers</h2>
      <p class="text-slate-600 max-w-2xl"><i>A weekly wrap of European markets: what moved, why it mattered, and what’s next.</i></p>
    </div>
  </section>

  <main class="wrap">

    <!-- Uploader -->
    <section id="upload" class="editor" aria-labelledby="uploader-title">
      <div class="flex items-center justify-between mb-2">
        <strong id="uploader-title">Upload article</strong>
        <span class="text-xs text-slate-500" id="draftStatus">Draft</span>
      </div>

      <div class="field"><label for="aTitle">Title</label><input id="aTitle" placeholder="Week NN — headline"/></div>
      <div class="field"><label for="aSubtitle">Subtitle / Deck</label><textarea id="aSubtitle" rows="2" placeholder="Short deck as in the example"></textarea></div>
      <div class="two">
        <div class="field"><label for="aAuthor">Author</label><input id="aAuthor" placeholder="Your name" value="Jacopo Berton"/></div>
        <div class="field"><label for="aDate">Date</label><input id="aDate" type="date"/></div>
      </div>

      <div class="two">
        <div class="field"><label for="aTags">Tags (comma-separated)</label><input id="aTags" placeholder="Equities, Rates, FX"/></div>
        <div class="field"><label for="aExcerpt">Excerpt (optional)</label><input id="aExcerpt" placeholder="Short summary used in previews"/></div>
      </div>

      <div class="two">
        <div class="field"><label for="aCoverUrl">Cover image URL</label><input id="aCoverUrl" placeholder="https://... (optional)"/></div>
        <div class="field"><label for="aCoverFile">Or upload cover file</label><input id="aCoverFile" type="file" accept="image/*"/></div>
      </div>

      <div class="tabs" role="tablist">
        <button id="tabText" class="active" type="button" data-view-allowed>Text</button>
        <button id="tabHtml" type="button" data-view-allowed>HTML</button>
      </div>

      <div id="paneText" role="tabpanel">
        <div class="field"><label for="aText">Text content</label><textarea id="aText" rows="10" placeholder="Write your article as plain text. Use blank lines between paragraphs."></textarea></div>
      </div>
      <div id="paneHtml" role="tabpanel" hidden>
        <div class="field"><label for="aHtml">HTML content</label><textarea id="aHtml" rows="12" placeholder="Paste full HTML or snippets (e.g. &lt;h2&gt;, &lt;p&gt;, &lt;ul&gt;, callouts)"></textarea></div>
      </div>

      <div class="two">
        <button id="publishBtn" class="pill-btn primary" type="button" data-view-allowed>Publish</button>
        <button id="clearBtn"   class="pill-btn"          type="button" data-view-allowed>Clear form</button>
      </div>
    </section>

    <!-- FEED -->
    <section id="feed" aria-label="Post list" class="mt-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-extrabold">All posts</h3>
        <span id="feedCount" class="text-xs text-slate-500">0</span>
      </div>
      <div id="feedGrid" class="cards"></div>
      <p id="emptyFeed" class="text-slate-500 text-sm mt-2">No posts yet. Publish your first above.</p>
    </section>

    <!-- Toolbar -->
    <div id="articleToolbar" class="mb-2" hidden>
      <button id="backToFeed" class="pill-btn" type="button" data-view-allowed>← Back to posts</button>
    </div>

    <!-- Article -->
    <section id="article" class="article" aria-labelledby="postTitle" hidden>
      <article class="post">
        <header class="post-head">
          <h1 id="postTitle"></h1>
          <p id="postSubtitle" class="subtitle"></p>
          <div class="meta">
            <span id="postAuthor"></span>
            <span>•</span>
            <time id="postDate" datetime=""></time>
            <span>•</span>
            <span id="postReadTime"></span>
            <div id="postTags" class="flex gap-2" style="margin-left:8px"></div>
          </div>
        </header>
        <div id="postBody" class="prose"></div>
      </article>

      <!-- Comments (viewer-safe) -->
      <section id="comments" class="comments" aria-labelledby="commentsTitle" data-view-allowed hidden>
        <div class="flex items-center justify-between">
          <h3 id="commentsTitle" class="text-lg font-extrabold">Comments</h3>
          <span id="commentsCount" class="text-xs text-slate-500">0</span>
        </div>
        <div id="commentsList" class="mt-2"></div>
        <form id="commentForm" class="editor mt-3" aria-label="Add a comment" data-view-allowed>
          <div class="two">
            <div class="field"><label for="cName">Name</label><input id="cName" autocomplete="name" placeholder="Your name" data-view-allowed/></div>
            <div class="field"><label for="cEmail">Email (not shown)</label><input id="cEmail" type="email" autocomplete="email" placeholder="you@example.com" data-view-allowed/></div>
          </div>
          <div class="field"><label for="cText">Comment</label><textarea id="cText" rows="4" placeholder="Be respectful. No HTML allowed." data-view-allowed></textarea></div>
          <div class="flex items-center justify-between">
            <span class="text-xs text-slate-500">Stored in Supabase if available (falls back locally).</span>
            <button class="pill-btn primary" type="submit" data-view-allowed>Post comment</button>
          </div>
        </form>
      </section>
    </section>
  </main>

  <footer>
    <div class="wrap mini" style="margin-top:6px; display:flex; justify-content:center; align-items:center; gap:10px; flex-wrap:wrap; text-align:center;">
      <span>© 2025 The (un)Stable Net</span>
      <span aria-hidden="true">•</span>
      <a href="assets/legal/privacy-policy.pdf" target="_blank" rel="noopener noreferrer" class="hover:underline underline-offset-4">Privacy Policy (PDF)</a>
      <span aria-hidden="true" class="hidden sm:inline">•</span>
      <a href="assets/legal/terms.pdf" target="_blank" rel="noopener noreferrer" class="hover:underline underline-offset-4">Terms &amp; Conditions (PDF)</a>
    </div>
  </footer>

  <!-- Contribute dialog -->
  <dialog id="contribDialog" class="contrib" data-to-email="jacopoberton98@gmail.com" data-view-allowed>
    <form method="dialog" id="contribFormContainer" data-view-allowed>
      <div class="dlg-head">
        <strong>Contribute to EMM</strong>
        <button class="close-x" id="closeContrib" value="cancel" aria-label="Close" type="button" data-view-allowed>Close</button>
      </div>
      <div class="dlg-body">
        <div class="two">
          <div class="field"><label for="ctName">Name</label><input id="ctName" required placeholder="Your name" data-view-allowed/></div>
          <div class="field"><label for="ctEmail">Email</label><input id="ctEmail" type="email" required placeholder="you@example.com" data-view-allowed/></div>
        </div>

        <div class="two">
          <div class="field">
            <label for="ctType">Contribution type</label>
            <select id="ctType" data-view-allowed>
              <option>Market tip / lead</option>
              <option>Chart / data point</option>
              <option>Event / macro idea</option>
              <option>Product feedback</option>
              <option>Other</option>
            </select>
          </div>
          <div class="field">
            <label for="ctFile">Attachment (optional)</label>
            <input id="ctFile" type="file" data-view-allowed/>
          </div>
        </div>

        <div class="field"><label for="ctMsg">Message</label><textarea id="ctMsg" rows="6" required placeholder="What would you like to share?" data-view-allowed></textarea></div>
        <label class="consent"><input type="checkbox" id="ctConsent" data-view-allowed/> <span>I consent to being contacted about this submission.</span></label>
        <small class="hint">On submit, your mail app opens with a pre‑filled email to the contact address.</small>
      </div>
      <div class="dlg-actions modal-actions">
        <button class="pill-btn btn-ghost" value="cancel" type="button" id="cancelContrib" data-view-allowed>Cancel</button>
        <button class="pill-btn btn-primary" id="submitContrib" type="button" data-view-allowed>Send</button>
      </div>
    </form>
  </dialog>

  <!-- Contrib wiring -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const btn = document.getElementById('openContrib');
      const dlg = document.getElementById('contribDialog');
      const closeBtn = document.getElementById('closeContrib');
      const cancelBtn = document.getElementById('cancelContrib');
      const submitBtn = document.getElementById('submitContrib');
      const form = document.getElementById('contribFormContainer');
      const fileInput = document.getElementById('ctFile');

      function open() { if (!dlg) return; if (typeof dlg.showModal === 'function') dlg.showModal(); else dlg.style.display = 'block'; }
      function close(e) { if (e) e.preventDefault(); if (!dlg) return; if (dlg.open && typeof dlg.close === 'function') dlg.close(); else dlg.style.display = 'none'; }

      if (btn && dlg) btn.addEventListener('click', open, { capture: true });
      if (closeBtn) closeBtn.addEventListener('click', close, { capture: true });
      if (cancelBtn) cancelBtn.addEventListener('click', close, { capture: true });
      if (dlg) dlg.addEventListener('click', (e) => { const r = dlg.getBoundingClientRect(); if (e.clientX < r.left || e.clientX > r.right || e.clientY < r.top || e.clientY > r.bottom) close(); }, { capture: true });

      // Supabase helpers (reuse if present)
      const hasSB = () => !!(window.supabase || (window.sb && window.sb.supabase));
      const sb = () => window.supabase || (window.sb && window.sb.supabase) || null;

      async function tryUploadAttachment(file){
        if(!hasSB() || !file) return null;
        try{
          const safeName = (file.name || 'upload').replace(/\\s+/g,'-');
          const path = `contrib/${Date.now()}-${safeName}`;
          const up = await sb().storage.from('emm-contrib').upload(path, file, { upsert:true, contentType: file.type || 'application/octet-stream' });
          if(up.error){ console.warn('Upload failed', up.error); return null; }
          const pub = sb().storage.from('emm-contrib').getPublicUrl(path);
          return (pub && pub.data && pub.data.publicUrl) ? pub.data.publicUrl : null;
        }catch(err){ console.warn('Storage exception', err); return null; }
      }

      function allowURL(u){
        if(!u) return null;
        try{
          if(/^data:image\\//i.test(u) || /^blob:/i.test(u)) return u;
          const url = new URL(u, location.origin);
          if(url.protocol === 'https:') return url.href;
        }catch{}
        return null;
      }

      async function sendMail() {
        const name = (document.getElementById('ctName').value || '').trim();
        const email = (document.getElementById('ctEmail').value || '').trim();
        const msg = (document.getElementById('ctMsg').value || '').trim();
        const type = (document.getElementById('ctType').value || '').trim();
        const consent = document.getElementById('ctConsent').checked ? 'Yes' : 'No';
        if (!msg) return;

        let attachmentNote = '';
        const f = fileInput && fileInput.files && fileInput.files[0];
        if (f){
          const uploaded = await tryUploadAttachment(f);
          if (uploaded && allowURL(uploaded)) attachmentNote = `\\nAttachment: ${uploaded}`;
          else attachmentNote = `\\nAttachment selected but not included via email (mailto limitations).`;
        }

        const to = (dlg && dlg.dataset.toEmail) || 'jacopoberton98@gmail.com';
        const subject = `EMM Contribution — ${type || 'Submission'} — from ${name || 'Anonymous'}`;
        const body = `Name: ${name}\\nEmail: ${email}\\nType: ${type}\\nConsent to contact: ${consent}${attachmentNote}\\n\\n${msg}\\n\\n— sent from EMM page`;
        window.location.href = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        close();
      }

      if (submitBtn) submitBtn.addEventListener('click', (e) => { e.preventDefault(); sendMail(); }, { capture: true });
      if (form) form.addEventListener('submit', (e) => { e.preventDefault(); sendMail(); }, { capture: true });
    });
  </script>

  <!-- Main app (Supabase + local fallback) -->
  <script>
    /* Device hints */
    (function(){
      const ro = () => {
        const w = window.innerWidth;
        document.documentElement.classList.toggle('mobile', w < 640);
        document.documentElement.classList.toggle('tablet', w >= 640 && w < 1024);
        document.documentElement.classList.toggle('desktop', w >= 1024);
      };
      ro(); window.addEventListener('resize', () => { clearTimeout(window.__rT); window.__rT=setTimeout(ro,120); });
      if (window.matchMedia('(pointer: coarse)').matches) document.documentElement.classList.add('touch');
    })();

    /* Sanitizer */
    function sanitizeHTML(html) {
      if (!html) return '';
      const tmpl = document.createElement('template');
      tmpl.innerHTML = html;
      const BLOCK = new Set(['SCRIPT','IFRAME','OBJECT','EMBED','LINK','STYLE']);
      const allowProtocol = (url) => {
        try {
          if (url.startsWith('data:')) return /^data:image\\//i.test(url);
          const u = new URL(url, location.origin);
          return ['http:','https:','mailto:','tel:'].includes(u.protocol);
        } catch { return !/^\\s*javascript:/i.test(url); }
      };
      const walker = document.createNodeIterator(tmpl.content, NodeFilter.SHOW_ELEMENT);
      let node, kill = [];
      while ((node = walker.nextNode())) {
        if (BLOCK.has(node.tagName)) { kill.push(node); continue; }
        [...node.attributes].forEach(a => {
          const n=a.name.toLowerCase(), v=a.value||'';
          if (n==='style' || n.startsWith('on')) node.removeAttribute(a.name);
          if ((n==='href'||n==='src') && v && !allowProtocol(v)) node.removeAttribute(a.name);
        });
      }
      kill.forEach(el => el.remove());
      return tmpl.innerHTML;
    }

    /* Utils */
    const $ = id => document.getElementById(id);
    const hasSB = () => !!(window.supabase || (window.sb && window.sb.supabase));
    const sb = () => window.supabase || (window.sb && window.sb.supabase) || null;

    const LS_POSTS = 'emm_posts';
    const COMMENTS_KEY = id => `emm_comments_${id}`;
    const slugify = s => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,80);
    const genId = () => Date.now().toString(36) + Math.random().toString(36).slice(2,8);
    function stripToText(html){ const d=document.createElement('div'); d.innerHTML=html; return (d.textContent||'').trim(); }
    function textToHtml(text){ if(!text) return ''; const esc=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); return esc.trim().split(/\\n{2,}/).map(p=>`<p>${p.replace(/\\n/g,'<br>')}</p>`).join('\\n'); }
    function wordCount(html){ return (stripToText(html).match(/\\S+/g)||[]).length; }
    function tagsFragment(tagsStr){ const frag=document.createDocumentFragment(); (tagsStr||'').split(',').map(s=>s.trim()).filter(Boolean).forEach(t=>{ const span=document.createElement('span'); span.className='chip'; span.textContent=t; frag.appendChild(span); }); return frag; }

    // safer cover setter
    const allowCoverURL = (u)=>{
      if(!u) return null;
      try{
        if(/^data:image\\//i.test(u)) return u;
        if(/^blob:/i.test(u)) return u;
        const url = new URL(u, location.origin);
        if(url.protocol === 'https:') return url.href;
      }catch{}
      return null;
    };
    function setHeroCover(url){
      const hero=document.querySelector('.hero.financial'); if(!hero) return;
      const safe = allowCoverURL(url);
      if(safe){ hero.style.setProperty('--hero', `url("${safe.replace(/"/g,'\\"')}")`); }
      else { hero.style.removeProperty('--hero'); }
    }

    /* -------- Supabase DATA LAYER (with local fallback) -------- */

    // POSTS
    async function sbListPosts(){
      if(!hasSB()) return JSON.parse(localStorage.getItem(LS_POSTS)||'[]');
      const { data, error } = await sb().from('emm_posts').select('*').order('dateISO', { ascending:false });
      if(error){ console.warn('Supabase list error:', error); return JSON.parse(localStorage.getItem(LS_POSTS)||'[]'); }
      return data || [];
    }
    async function sbInsertPost(post){
      if(!hasSB()){
        // local fallback
        const list = JSON.parse(localStorage.getItem(LS_POSTS)||'[]');
        list.unshift(post); localStorage.setItem(LS_POSTS, JSON.stringify(list));
        return { data: post };
      }
      const { data, error } = await sb().from('emm_posts').upsert(post, { onConflict:'id' }).select().single();
      if(error){ console.error('Supabase upsert error:', error); return { error }; }
      return { data };
    }
    async function sbFindPostById(id){
      if(!hasSB()){
        const list = JSON.parse(localStorage.getItem(LS_POSTS)||'[]'); return list.find(p=>p.id===id) || null;
      }
      const { data, error } = await sb().from('emm_posts').select('*').eq('id', id).maybeSingle();
      if(error){ console.warn('findById error:', error); return null; }
      return data;
    }
    async function sbFindPostBySlug(slug){
      if(!hasSB()){
        const list = JSON.parse(localStorage.getItem(LS_POSTS)||'[]'); return list.find(p=>(p.slug||'')===slug) || null;
      }
      const { data, error } = await sb().from('emm_posts').select('*').eq('slug', slug).maybeSingle();
      if(error){ console.warn('findBySlug error:', error); return null; }
      return data;
    }
    async function sbLatestPost(){
      if(!hasSB()){
        const list = JSON.parse(localStorage.getItem(LS_POSTS)||'[]'); return list.sort((a,b)=> (b.dateISO||'').localeCompare(a.dateISO||''))[0] || null;
      }
      const { data, error } = await sb().from('emm_posts').select('*').order('dateISO', { ascending:false }).limit(1).maybeSingle();
      if(error){ console.warn('latest error:', error); return null; }
      return data;
    }

    // COMMENTS
    async function sbListComments(postId){
      if(!hasSB()) return JSON.parse(localStorage.getItem(COMMENTS_KEY(postId))||'[]');
      const { data, error } = await sb().from('emm_comments').select('*').eq('post_id', postId).order('created_at', { ascending:true });
      if(error){ console.warn('comments list error:', error); return JSON.parse(localStorage.getItem(COMMENTS_KEY(postId))||'[]'); }
      return data || [];
    }
    async function sbAddComment(postId, {name, email, text}){
      const item = { post_id: postId, name, email, text, timeISO: new Date().toISOString() };
      if(!hasSB()){
        const arr = JSON.parse(localStorage.getItem(COMMENTS_KEY(postId))||'[]'); arr.push(item); localStorage.setItem(COMMENTS_KEY(postId), JSON.stringify(arr)); return { data:item };
      }
      const { data, error } = await sb().from('emm_comments').insert(item).select().single();
      if(error){ console.error('comment insert error:', error); return { error }; }
      return { data };
    }

    // COVER UPLOAD (to Supabase Storage; falls back to data URL)
    async function tryUploadCover(file, postId){
      if(!hasSB() || !file) return null;
      try{
        const path = `covers/${postId}-${(file.name||'cover').replace(/\\s+/g,'-')}`;
        const up = await sb().storage.from('emm-covers').upload(path, file, { upsert:true, contentType: file.type || 'image/*' });
        if(up.error){ console.warn('Storage upload failed, using data URL fallback', up.error); return null; }
        const pub = sb().storage.from('emm-covers').getPublicUrl(path);
        return (pub && pub.data && pub.data.publicUrl) ? pub.data.publicUrl : null;
      }catch(err){ console.warn('Storage exception, fallback to data URL', err); return null; }
    }

    function renderFeedItems(items){
      const grid = $('feedGrid'), count=$('feedCount'), empty=$('emptyFeed');
      if(!grid) return;
      grid.innerHTML = '';
      count.textContent = items.length;
      empty.hidden = items.length>0;

      for(const p of items){
        const card = document.createElement('a');   // anchor = native link
        card.className = 'card';
        card.href = `#post/${p.id}`;
        card.setAttribute('data-view-allowed','');
        card.dataset.id = p.id;

        if (p.cover){
          const img = document.createElement('img');
          img.className = 'thumb'; img.alt = ''; img.loading = 'lazy';
          img.src = p.cover;
          card.appendChild(img);
        }

        const body = document.createElement('div'); body.className='body';
        const h4 = document.createElement('h4'); h4.textContent = p.title || 'Untitled';
        const deck = document.createElement('p'); deck.className='deck';
        deck.textContent = p.excerpt || p.subtitle || stripToText(p.body_html || p.bodyHtml).slice(0,180);
        const meta = document.createElement('div'); meta.className='meta';
        const dt = new Date(p.dateISO||p.date_iso||Date.now());
        const mins = p.minutes || Math.max(1, Math.round(wordCount(p.body_html || p.bodyHtml)/220));
        meta.textContent = `${dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'})} • ${mins} min`;

        body.append(h4, deck, meta);
        card.appendChild(body);
        grid.appendChild(card);
      }
    }

    function normalizePost(p){
      return {
        id: p.id,
        slug: p.slug,
        title: p.title,
        subtitle: p.subtitle,
        author: p.author,
        dateISO: p.dateISO || p.date_iso,
        tagsStr: p.tagsStr || p.tags_str,
        excerpt: p.excerpt,
        cover: p.cover || p.cover_url,
        bodyHtml: p.bodyHtml || p.body_html,
        minutes: p.minutes
      };
    }

    async function renderFeed(){
      const items = await sbListPosts();
      const norm = items.map(normalizePost).sort((a,b)=> (b.dateISO||'').localeCompare(a.dateISO||''));
      renderFeedItems(norm);
    }

    function renderCommentsList(items){
      const listEl = $('commentsList'), countEl=$('commentsCount');
      if (!listEl) return;
      listEl.innerHTML = items.map(c => `
        <div class="comment-item" data-view-allowed>
          <div class="comment-author">${(c.name||'Anonymous')}</div>
          <div class="comment-meta">${new Date(c.timeISO || c.time_iso || c.created_at).toLocaleString()}</div>
          <div class="comment-text">${String(c.text||'').replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s]))}</div>
        </div>
      `).join('');
      if (countEl) countEl.textContent = items.length;
    }

    async function renderPost(pRaw){
      if(!pRaw) return;
      const p = normalizePost(pRaw);

      const postTitle = $('postTitle'), postSubtitle=$('postSubtitle'), postAuthor=$('postAuthor'),
            postDate=$('postDate'), postReadTime=$('postReadTime'), postTags=$('postTags'),
            postBody=$('postBody'), articleSec=$('article'), toolbar=$('articleToolbar'), commentsSec=$('comments');

      postTitle.textContent = p.title || 'Untitled';
      postSubtitle.textContent = p.subtitle || '';
      postAuthor.textContent = p.author || '—';
      const dt = new Date(p.dateISO||Date.now());
      postDate.textContent = dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
      postDate.setAttribute('datetime', p.dateISO || '');
      postReadTime.textContent = `${Math.max(1, Math.round((p.minutes||wordCount(p.bodyHtml)/220)))} min read`;
      postTags.innerHTML=''; postTags.appendChild(tagsFragment(p.tagsStr||''));
      postBody.innerHTML = sanitizeHTML(p.bodyHtml || '');

      setHeroCover(p.cover||'');

      if(articleSec) articleSec.hidden = false;
      if($('feed')) $('feed').hidden = true;
      if(toolbar) toolbar.hidden = false;
      if(commentsSec) { commentsSec.hidden = false; commentsSec.setAttribute('data-view-allowed',''); }

      const comments = await sbListComments(p.id);
      renderCommentsList(comments);

      const form = $('commentForm');
      if (form && !form.dataset.bound) {
        form.dataset.bound = '1';
        form.addEventListener('submit', async (e)=>{
          e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation?.();
          const name = $('cName').value.trim();
          const email= $('cEmail').value.trim();
          const text = $('cText').value.trim();
          if (!text) return;
          await sbAddComment(p.id, {name, email, text});
          $('cText').value = '';
          const updated = await sbListComments(p.id);
          renderCommentsList(updated);
        }, {capture:true});
      }
    }

    async function goToFeed(){ if($('article')) $('article').hidden = true; if($('articleToolbar')) $('articleToolbar').hidden = true; if($('feed')) $('feed').hidden = false; setHeroCover(''); await renderFeed(); }

    async function onRoute(){
      const hash = location.hash || '';
      const q = new URLSearchParams(location.search);
      if (hash.startsWith('#post/')) { const p = await sbFindPostById(hash.slice(6)); return p ? renderPost(p) : goToFeed(); }
      if (hash.startsWith('#slug/')) { const p = await sbFindPostBySlug(decodeURIComponent(hash.slice(6))); return p ? renderPost(p) : goToFeed(); }
      if (hash === '#latest')       { const p = await sbLatestPost(); return p ? renderPost(p) : goToFeed(); }
      if (q.has('id'))              { const p = await sbFindPostById(q.get('id')); return p ? renderPost(p) : goToFeed(); }
      if (q.has('slug'))            { const p = await sbFindPostBySlug(q.get('slug')); return p ? renderPost(p) : goToFeed(); }
      return goToFeed();
    }

    document.addEventListener('DOMContentLoaded', () => {
      ['publishBtn','clearBtn','tabText','tabHtml','backToFeed','commentForm','cName','cEmail','cText'].forEach(id=>{
        const el=$(id); if(el){ el.removeAttribute('disabled'); el.setAttribute('data-view-allowed',''); el.style.pointerEvents='auto'; }
      });

      const tabText  = $('tabText'), tabHtml = $('tabHtml');
      const paneText = $('paneText'), paneHtml = $('paneHtml');
      const showTab = (which)=>{ const isHtml = which==='html'; tabText?.classList.toggle('active', !isHtml); tabHtml?.classList.toggle('active', isHtml); if(paneText) paneText.hidden = isHtml; if(paneHtml) paneHtml.hidden = !isHtml; };
      const safe = fn => e=>{ e.stopImmediatePropagation?.(); e.stopPropagation?.(); e.preventDefault?.(); fn(); };
      tabText?.addEventListener('click', safe(()=>showTab('text')), {capture:true});
      tabHtml?.addEventListener('click', safe(()=>showTab('html')), {capture:true});

      $('backToFeed')?.addEventListener('click', safe(()=>{ location.hash=''; }), {capture:true});

      const aTitle=$('aTitle'), aSubtitle=$('aSubtitle'), aAuthor=$('aAuthor'), aDate=$('aDate'), aTags=$('aTags'),
            aExcerpt=$('aExcerpt'), aCoverUrl=$('aCoverUrl'), aCoverFile=$('aCoverFile'),
            aText=$('aText'), aHtml=$('aHtml');
      const btnPublish=$('publishBtn'), btnClear=$('clearBtn'), draftStatus=$('draftStatus');

      function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

      btnPublish?.addEventListener('click', safe(async ()=>{
        const id = genId();
        const title    = (aTitle.value||'').trim() || 'Untitled';
        const subtitle = (aSubtitle.value||'').trim();
        const author   = (aAuthor.value||'').trim();
        const dateISO  = aDate.value || new Date().toISOString().slice(0,10);
        const tagsStr  = (aTags.value||'').trim();
        const excerpt  = (aExcerpt.value||'').trim();

        let cover = allowCoverURL((aCoverUrl.value||'').trim());
        const f = aCoverFile.files && aCoverFile.files[0];
        if (f){
          const uploaded = await tryUploadCover(f, id);
          cover = allowCoverURL(uploaded) || await readFileAsDataURL(f);
        }

        const isHtmlMode = tabHtml?.classList.contains('active');
        const bodyHtml = isHtmlMode ? sanitizeHTML(aHtml.value||'') : sanitizeHTML(textToHtml(aText.value||''));
        const minutes = Math.max(1, Math.round(wordCount(bodyHtml)/220));
        const slug = slugify(title) || ('post-'+id);

        const post = {
          id, slug, title, subtitle, author,
          dateISO, tagsStr, excerpt,
          cover, body_html: bodyHtml, minutes
        };

        const res = await sbInsertPost(post);
        if(res.error){ alert('Could not publish. Check console.'); return; }

        draftStatus.textContent = 'Published';
        draftStatus.classList.add('text-green-600');

        await renderFeed();
        window.scrollTo({ top: $('feed').offsetTop - 10, behavior:'smooth' });
      }), {capture:true});

      btnClear?.addEventListener('click', safe(()=>{
        document.querySelectorAll('#upload input, #upload textarea').forEach(el=>{ el.type==='file' ? el.value='' : el.value=''; });
        draftStatus.textContent='Draft'; draftStatus.classList.remove('text-green-600');
      }), {capture:true});

      renderFeed();
      window.addEventListener('hashchange', ()=>{ onRoute(); });
      onRoute();
    });
  </script>
  <script>
(function(){
  const btn = document.getElementById('navToggle');
  const nav = document.getElementById('primaryNav');
  if(!btn || !nav) return;

  // Toggle apertura/chiusura
  btn.addEventListener('click', ()=>{
    const open = document.body.classList.toggle('nav-open');
    btn.setAttribute('aria-expanded', open ? 'true' : 'false');
  });

  // Assicura che l'hamburger NON si veda su desktop
  const mq = matchMedia('(max-width:980px)');
  const update = ()=>{ btn.style.display = mq.matches ? 'inline-flex' : 'none'; };
  update(); mq.addEventListener('change', update);

  // Compatibilità con il tuo "viewer"
  try { btn.setAttribute('data-view-allowed',''); nav.querySelectorAll('a').forEach(a=>a.setAttribute('data-view-allowed','')); } catch(_){}
})();
</script>


  <!-- Supabase init (keep yours) -->
  <script type="module" src="assets/sb-init.js"></script>
  <script type="module" src="assets/dynamic-emm-content.js"></script>
  <!-- Optional: your editor helpers -->
  <!-- <script type="module" src="assets/dynamic-emm.js"></script> -->
  <script type="module" src="assets/editor-auth.js"></script>
  <script type="module" src="assets/editor-tray.js"></script>
  <script type="module" src="assets/editor-quiet.js"></script>
  <script type="module" src="assets/editor-unlock.js"></script>
<script type="module" src="assets/live-all-norepl.js"></script>
</body></html>
